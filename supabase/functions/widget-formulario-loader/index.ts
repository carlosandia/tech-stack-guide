const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders })
  }

  const url = new URL(req.url)
  const slug = url.searchParams.get('slug')
  const mode = url.searchParams.get('mode') || 'inline'

  if (!slug) {
    return new Response('// Error: slug required', {
      status: 400,
      headers: { ...corsHeaders, 'Content-Type': 'application/javascript; charset=utf-8' },
    })
  }

  const SUPABASE_URL = Deno.env.get('SUPABASE_URL')!
  const ANON_KEY = Deno.env.get('SUPABASE_ANON_KEY')!
  const configApi = SUPABASE_URL + '/functions/v1/widget-formulario-config?slug=' + slug
  const submitApi = SUPABASE_URL + '/functions/v1/processar-submissao-formulario'

  const js = getFormScript(configApi, submitApi, mode, slug, ANON_KEY)

  return new Response(js, {
    status: 200,
    headers: {
      ...corsHeaders,
      'Content-Type': 'application/javascript; charset=utf-8',
      'Cache-Control': 'public, max-age=3600, s-maxage=86400',
    },
  })
})

function getFormScript(configApi: string, submitApi: string, mode: string, slug: string, anonKey: string): string {
  // Build the JS as string concatenation to avoid template literal issues
  const parts: string[] = []
  
  parts.push("(function(){")
  parts.push("var API='" + configApi + "';")
  parts.push("var SUBMIT='" + submitApi + "';")
  parts.push("var MODE='" + mode + "';")
  parts.push("var SLUG='" + slug + "';")
  parts.push("var ANON='" + anonKey + "';")
  parts.push("var el=document.currentScript||document.querySelector('script[data-form-slug=\"'+SLUG+'\"]');")
  parts.push("var parent=el?el.parentNode:document.body;")
  
  parts.push("function inputType(t){switch(t){case'email':return'email';case'telefone':case'telefone_br':return'tel';case'numero':case'decimal':return'number';case'url':return'url';case'data':return'date';case'data_hora':return'datetime-local';case'hora':return'time';default:return'text'}}")

  // AIDEV-NOTE: ensurePx inline â€” converte nÃºmeros puros para px no widget embed
  parts.push("function ensurePx(v,fb){if(v===undefined||v===null||v==='')return fb;var t=String(v).trim();if(!t)return fb;if(/[a-z%]/i.test(t))return t;return t+'px'}")

  // AIDEV-NOTE: mergeCampoEstilo inline â€” merge estilos globais com overrides individuais do campo
  parts.push("function mergeFieldStyle(globalFS,campo){var ec=(campo.validacoes||{}).estilo_campo||{};if(!ec||Object.keys(ec).length===0)return globalFS;var m={};for(var k in globalFS)m[k]=globalFS[k];for(var k2 in ec){if(ec[k2]!==undefined&&ec[k2]!==null&&ec[k2]!=='')m[k2]=ec[k2]}return m}")
  parts.push("function isLayoutField(t){return['titulo','paragrafo','divisor','espacador','html_block','bloco_html','imagem_link','botao_enviar','botao_whatsapp','bloco_colunas'].indexOf(t)>=0}")
  parts.push("function isLayoutOnly(t){return['titulo','paragrafo','divisor','espacador','bloco_html','imagem_link'].indexOf(t)>=0}")

  // Masks â€” AIDEV-NOTE: Use \\D (single backslash in output JS) to match non-digits
  parts.push("function maskFor(tipo){")
  parts.push("if(tipo==='telefone_br')return function(el){el.setAttribute('maxlength','16');el.addEventListener('input',function(){var v=this.value.replace(/\\D/g,'');if(v.length>11)v=v.slice(0,11);if(v.length>10)this.value='('+v.slice(0,2)+') '+v.slice(2,7)+'-'+v.slice(7);else if(v.length>6)this.value='('+v.slice(0,2)+') '+v.slice(2,6)+'-'+v.slice(6);else if(v.length>2)this.value='('+v.slice(0,2)+') '+v.slice(2);else if(v.length>0)this.value='('+v;else this.value=''})};")
  parts.push("if(tipo==='telefone')return function(el){el.setAttribute('maxlength','15');el.addEventListener('input',function(){var v=this.value.replace(/\\D/g,'');if(v.length>15)v=v.slice(0,15);this.value=v})};")
  parts.push("if(tipo==='cpf')return function(el){el.setAttribute('maxlength','14');el.addEventListener('input',function(){var v=this.value.replace(/\\D/g,'');if(v.length>11)v=v.slice(0,11);if(v.length>9)this.value=v.slice(0,3)+'.'+v.slice(3,6)+'.'+v.slice(6,9)+'-'+v.slice(9);else if(v.length>6)this.value=v.slice(0,3)+'.'+v.slice(3,6)+'.'+v.slice(6);else if(v.length>3)this.value=v.slice(0,3)+'.'+v.slice(3);else this.value=v})};")
  parts.push("if(tipo==='cnpj')return function(el){el.setAttribute('maxlength','18');el.addEventListener('input',function(){var v=this.value.replace(/\\D/g,'');if(v.length>14)v=v.slice(0,14);if(v.length>12)this.value=v.slice(0,2)+'.'+v.slice(2,5)+'.'+v.slice(5,8)+'/'+v.slice(8,12)+'-'+v.slice(12);else if(v.length>8)this.value=v.slice(0,2)+'.'+v.slice(2,5)+'.'+v.slice(5,8)+'/'+v.slice(8);else if(v.length>5)this.value=v.slice(0,2)+'.'+v.slice(2,5)+'.'+v.slice(5);else if(v.length>2)this.value=v.slice(0,2)+'.'+v.slice(2);else this.value=v})};")
  parts.push("if(tipo==='cep')return function(el){el.setAttribute('maxlength','9');el.addEventListener('input',function(){var v=this.value.replace(/\\D/g,'');if(v.length>8)v=v.slice(0,8);if(v.length>5)this.value=v.slice(0,5)+'-'+v.slice(5);else this.value=v;if(v.length===8){var wrapper=this.closest('[data-form-id]');if(!wrapper)return;fetch('https://viacep.com.br/ws/'+v+'/json/').then(function(r){return r.json()}).then(function(d){if(d.erro)return;var endG=wrapper.querySelector('[data-campo-tipo=\"endereco\"]');if(endG){var ruaInp=endG.querySelector('input[name$=\"_rua\"]');if(ruaInp)ruaInp.value=d.logradouro||''}var estG=wrapper.querySelector('[data-campo-tipo=\"estado\"]');if(estG){var estSel=estG.querySelector('select');if(estSel)estSel.value=d.uf||''}var cidG=wrapper.querySelector('[data-campo-tipo=\"cidade\"]');if(cidG){var cidInp=cidG.querySelector('input');if(cidInp)cidInp.value=d.localidade||''}var paisG=wrapper.querySelector('[data-campo-tipo=\"pais\"]');if(paisG){var paisSel=paisG.querySelector('select');if(paisSel){for(var pi=0;pi<paisSel.options.length;pi++){if(paisSel.options[pi].value.indexOf('BR')>=0){paisSel.value=paisSel.options[pi].value;break}}}}}).catch(function(){})}})};")
  parts.push("if(tipo==='moeda')return function(el){el.addEventListener('input',function(){var v=this.value.replace(/\\D/g,'');if(!v){this.value='';return}var cents=parseInt(v,10);var reais=(cents/100).toFixed(2).replace('.',',');this.value='R$ '+reais.replace(/\\B(?=(\\d{3})+(?!\\d))/g,'.')})};")
  parts.push("return null}")

  // Utils
  parts.push("function getUtms(){var p=new URLSearchParams(window.location.search);var u={};['utm_source','utm_medium','utm_campaign','utm_term','utm_content'].forEach(function(k){if(p.get(k))u[k]=p.get(k)});return u}")
  parts.push("function resolveLargura(l){if(!l||l==='full')return'100%';if(l==='auto')return'auto';return l}")
  parts.push("function parseLayoutConfig(vp,tipo){var d={};if(tipo==='titulo')d={alinhamento:'left',cor:'#374151',tamanho:'18'};else if(tipo==='paragrafo')d={alinhamento:'left',cor:'#374151',tamanho:'14'};else if(tipo==='divisor')d={cor:'#D1D5DB',espessura:'1',estilo:'solid'};else if(tipo==='espacador')d={altura:'16'};else return d;if(!vp)return d;try{var p=JSON.parse(vp);for(var k in d){if(p[k])d[k]=p[k]}return d}catch(e){return d}}")

  // DDI list for telefone internacional
  parts.push("var PAISES_DDI=[{c:'BR',d:'+55',f:'\\uD83C\\uDDE7\\uD83C\\uDDF7'},{c:'US',d:'+1',f:'\\uD83C\\uDDFA\\uD83C\\uDDF8'},{c:'PT',d:'+351',f:'\\uD83C\\uDDF5\\uD83C\\uDDF9'},{c:'AR',d:'+54',f:'\\uD83C\\uDDE6\\uD83C\\uDDF7'},{c:'CL',d:'+56',f:'\\uD83C\\uDDE8\\uD83C\\uDDF1'},{c:'CO',d:'+57',f:'\\uD83C\\uDDE8\\uD83C\\uDDF4'},{c:'MX',d:'+52',f:'\\uD83C\\uDDF2\\uD83C\\uDDFD'},{c:'UY',d:'+598',f:'\\uD83C\\uDDFA\\uD83C\\uDDFE'},{c:'PY',d:'+595',f:'\\uD83C\\uDDF5\\uD83C\\uDDFE'},{c:'PE',d:'+51',f:'\\uD83C\\uDDF5\\uD83C\\uDDEA'},{c:'DE',d:'+49',f:'\\uD83C\\uDDE9\\uD83C\\uDDEA'},{c:'FR',d:'+33',f:'\\uD83C\\uDDEB\\uD83C\\uDDF7'},{c:'ES',d:'+34',f:'\\uD83C\\uDDEA\\uD83C\\uDDF8'},{c:'IT',d:'+39',f:'\\uD83C\\uDDEE\\uD83C\\uDDF9'},{c:'GB',d:'+44',f:'\\uD83C\\uDDEC\\uD83C\\uDDE7'}];")
  parts.push("var ESTADOS_BR=['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'];")

  // renderField function - now receives fS (field styles) for border colors etc.
  parts.push("function renderField(c,group,labelCss,inputCss,fontFamily,borderColor,fS){")
  parts.push("if(isLayoutOnly(c.tipo))return;")

  // Label (skip for checkbox/checkbox_termos - they have inline labels)
  parts.push("var helpSvg='<svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#9CA3AF\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><line x1=\"12\" y1=\"16\" x2=\"12\" y2=\"12\"/><line x1=\"12\" y1=\"8\" x2=\"12.01\" y2=\"8\"/></svg>';")
  // Clickable help icon with popup (mobile-friendly)
  parts.push("function makeHelpIcon(txt){var wrap=document.createElement('span');wrap.style.cssText='position:relative;display:inline-flex;align-items:center;cursor:pointer;margin-left:2px';wrap.innerHTML=helpSvg;var pop=document.createElement('div');pop.style.cssText='display:none;position:absolute;left:50%;transform:translateX(-50%);bottom:calc(100% + 8px);background:#1F2937;color:#fff;font-size:12px;font-weight:400;padding:8px 12px;border-radius:8px;min-width:180px;max-width:260px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10000;line-height:1.4;white-space:normal;word-wrap:break-word';pop.textContent=txt;var arrow=document.createElement('div');arrow.style.cssText='position:absolute;left:50%;transform:translateX(-50%);top:100%;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:6px solid #1F2937';pop.appendChild(arrow);wrap.appendChild(pop);wrap.addEventListener('click',function(e){e.preventDefault();e.stopPropagation();if(pop.style.display==='none'){pop.style.display='block';setTimeout(function(){document.addEventListener('click',function handler(){pop.style.display='none';document.removeEventListener('click',handler)})},10)}else{pop.style.display='none'}});return wrap}")
  parts.push("function helpHtml(txt){return '<span class=\"crm-help-icon\" data-help=\"'+txt.replace(/\"/g,'&quot;')+'\" style=\"display:inline-flex;align-items:center;cursor:pointer;margin-left:2px\">'+helpSvg+'</span>'}")
  parts.push("if(c.tipo!=='checkbox'&&c.tipo!=='checkbox_termos'){var label=document.createElement('label');label.className='form-label';label.style.cssText=labelCss+';display:flex;align-items:center;gap:4px';label.innerHTML=c.label+(c.obrigatorio?' <span style=\"color:#EF4444\">*</span>':'');if(c.texto_ajuda){label.appendChild(makeHelpIcon(c.texto_ajuda))}group.appendChild(label)}")
  parts.push("var inp;")

  // TEXTAREA
  parts.push("if(c.tipo==='texto_longo'||c.tipo==='area_texto'){inp=document.createElement('textarea');inp.rows=3;inp.style.cssText=inputCss.replace(/height:[^;]+;/,'')+'height:80px;resize:vertical;'}")

  // TELEFONE INTERNACIONAL (com seletor DDI)
  parts.push("else if(c.tipo==='telefone'){var telWrap=document.createElement('div');telWrap.style.cssText='display:flex;align-items:stretch;gap:0';var ddiSel=document.createElement('select');ddiSel.name=c.nome+'_ddi';ddiSel.style.cssText=inputCss+';width:auto;min-width:90px;border-right:none;border-top-right-radius:0;border-bottom-right-radius:0;background:#F3F4F6;padding:8px 6px;appearance:auto;flex-shrink:0;box-sizing:border-box';var defaultCode=c.valor_padrao||'BR';for(var di=0;di<PAISES_DDI.length;di++){var dOpt=document.createElement('option');dOpt.value=PAISES_DDI[di].d;dOpt.textContent=PAISES_DDI[di].f+' '+PAISES_DDI[di].d;if(PAISES_DDI[di].c===defaultCode)dOpt.selected=true;ddiSel.appendChild(dOpt)}var telInp=document.createElement('input');telInp.type='tel';telInp.className='form-input-field';telInp.name=c.nome;if(c.placeholder)telInp.placeholder=c.placeholder;else telInp.placeholder='Digite aqui...';if(c.obrigatorio)telInp.required=true;telInp.style.cssText=inputCss+';border-top-left-radius:0;border-bottom-left-radius:0';telInp.addEventListener('focus',function(){this.style.borderColor='#3B82F6'});telInp.addEventListener('blur',function(){this.style.borderColor=borderColor});telWrap.appendChild(ddiSel);telWrap.appendChild(telInp);group.appendChild(telWrap);return}")

  // TELEFONE BR (com prefixo fixo ðŸ‡§ðŸ‡· +55)
  parts.push("else if(c.tipo==='telefone_br'){var telBrWrap=document.createElement('div');telBrWrap.style.cssText='display:flex;align-items:stretch;gap:0';var prefix=document.createElement('span');prefix.textContent='\\uD83C\\uDDE7\\uD83C\\uDDF7 +55';prefix.style.cssText=inputCss+';width:auto;border-right:none;border-top-right-radius:0;border-bottom-right-radius:0;display:flex;align-items:center;gap:4px;padding:8px 10px;background:#F3F4F6;color:#6B7280;font-size:14px;white-space:nowrap;flex-shrink:0;box-sizing:border-box';var telBrInp=document.createElement('input');telBrInp.type='tel';telBrInp.className='form-input-field';telBrInp.name=c.nome;telBrInp.placeholder=c.placeholder||'(00) 00000-0000';if(c.obrigatorio)telBrInp.required=true;telBrInp.style.cssText=inputCss+';border-top-left-radius:0;border-bottom-left-radius:0';telBrInp.addEventListener('focus',function(){this.style.borderColor='#3B82F6'});telBrInp.addEventListener('blur',function(){this.style.borderColor=borderColor});var mk=maskFor('telefone_br');if(mk)mk(telBrInp);telBrWrap.appendChild(prefix);telBrWrap.appendChild(telBrInp);group.appendChild(telBrWrap);return}")

  // SELECT (single)
  parts.push("else if((c.tipo==='select'||c.tipo==='dropdown'||c.tipo==='selecao')&&c.opcoes){inp=document.createElement('select');inp.style.cssText=inputCss+';appearance:auto';var defOpt=document.createElement('option');defOpt.value='';defOpt.textContent=c.placeholder||'Selecione...';inp.appendChild(defOpt);var opts=Array.isArray(c.opcoes)?c.opcoes:(c.opcoes.opcoes||[]);for(var j=0;j<opts.length;j++){var o=document.createElement('option');var val=typeof opts[j]==='string'?opts[j]:(opts[j].valor||opts[j].label||opts[j]);var lbl=typeof opts[j]==='string'?opts[j]:(opts[j].label||opts[j].valor||opts[j]);o.value=val;o.textContent=lbl;inp.appendChild(o)}}")

  // SELECAO MULTIPLA (checkboxes visuais)
  parts.push("else if(c.tipo==='selecao_multipla'&&c.opcoes){inp=document.createElement('div');inp.setAttribute('data-name',c.nome);inp.setAttribute('data-multi','1');var bc2=fS.input_border_color||borderColor||'#D1D5DB';var mOpts=Array.isArray(c.opcoes)?c.opcoes:(c.opcoes.opcoes||[]);for(var m=0;m<mOpts.length;m++){var mLabel=document.createElement('label');mLabel.style.cssText='display:flex;align-items:center;gap:8px;font-size:14px;color:#374151;cursor:pointer;padding:8px 12px;border:1px solid '+bc2+';border-radius:6px;margin-bottom:6px;transition:all 0.15s;background:#fff;font-family:'+fontFamily;var mInp=document.createElement('input');mInp.type='checkbox';mInp.style.cssText='width:16px;height:16px;accent-color:#3B82F6;flex-shrink:0';var mVal=typeof mOpts[m]==='string'?mOpts[m]:(mOpts[m].valor||mOpts[m].label||mOpts[m]);mInp.value=mVal;(function(bc3){mInp.addEventListener('change',function(){var p=this.parentElement;if(this.checked){p.style.borderColor='#3B82F6';p.style.backgroundColor='#EFF6FF'}else{p.style.borderColor=bc3;p.style.backgroundColor='#fff'}})})(bc2);mLabel.appendChild(mInp);mLabel.appendChild(document.createTextNode(typeof mOpts[m]==='string'?mOpts[m]:(mOpts[m].label||mOpts[m].valor||mOpts[m])));inp.appendChild(mLabel)}}")

  // CHECKBOX
  parts.push("else if(c.tipo==='checkbox'){var cbWrap=document.createElement('div');cbWrap.style.cssText='display:flex;align-items:center;gap:8px';var cbInp=document.createElement('input');cbInp.type='checkbox';cbInp.name=c.nome;cbInp.style.cssText='width:16px;height:16px;accent-color:#3B82F6';var cbLabel=document.createElement('span');cbLabel.style.cssText=labelCss+';margin-bottom:0';cbLabel.innerHTML=c.label+(c.obrigatorio?' <span style=\"color:#EF4444\">*</span>':'');if(c.texto_ajuda){cbLabel.appendChild(makeHelpIcon(c.texto_ajuda))}cbWrap.appendChild(cbInp);cbWrap.appendChild(cbLabel);group.appendChild(cbWrap);return}")

  // CHECKBOX TERMOS (com link "Ver termos" e modal)
  parts.push("else if(c.tipo==='checkbox_termos'){var ctWrap=document.createElement('div');ctWrap.style.cssText='display:flex;align-items:flex-start;gap:8px';var ctInp=document.createElement('input');ctInp.type='checkbox';ctInp.name=c.nome;if(c.obrigatorio)ctInp.required=true;ctInp.style.cssText='width:16px;height:16px;margin-top:2px;accent-color:#3B82F6;flex-shrink:0';var ctLabel=document.createElement('span');ctLabel.style.cssText=labelCss+';margin-bottom:0;font-size:13px';ctLabel.innerHTML=c.label+(c.obrigatorio?' <span style=\"color:#EF4444\">*</span>':'');if(c.valor_padrao){var termosLink=document.createElement('button');termosLink.type='button';termosLink.textContent='Ver termos';termosLink.style.cssText='color:#3B82F6;text-decoration:underline;background:none;border:none;cursor:pointer;font-size:13px;margin-left:4px;font-family:'+fontFamily+';padding:0';termosLink.addEventListener('click',function(ev){ev.preventDefault();ev.stopPropagation();var overlay=document.createElement('div');overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:2147483647;display:flex;align-items:center;justify-content:center;padding:20px;animation:crmFadeIn 0.3s ease;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);font-family:'+fontFamily;var modal=document.createElement('div');modal.style.cssText='background:#fff;border-radius:12px;max-width:500px;width:100%;max-height:70vh;overflow-y:auto;box-shadow:0 20px 60px -10px rgba(0,0,0,0.3);position:relative;z-index:2147483647;font-family:'+fontFamily;var mHeader=document.createElement('div');mHeader.style.cssText='padding:16px 20px;border-bottom:1px solid #E5E7EB;display:flex;align-items:center;justify-content:space-between';var mTitle=document.createElement('h3');mTitle.textContent='Termos de Uso';mTitle.style.cssText='margin:0;font-size:16px;font-weight:600;color:#111827;font-family:'+fontFamily;var mClose=document.createElement('button');mClose.type='button';mClose.textContent='\\u2715';mClose.style.cssText='background:none;border:none;font-size:18px;cursor:pointer;color:#6B7280;padding:4px;font-family:'+fontFamily;mClose.addEventListener('click',function(){overlay.remove()});mHeader.appendChild(mTitle);mHeader.appendChild(mClose);var mBody=document.createElement('div');mBody.style.cssText='padding:20px;font-size:14px;color:#4B5563;line-height:1.6;white-space:pre-wrap;font-family:'+fontFamily;mBody.textContent=c.valor_padrao||'Nenhum texto de termos configurado.';modal.appendChild(mHeader);modal.appendChild(mBody);overlay.appendChild(modal);overlay.addEventListener('click',function(e2){if(e2.target===overlay)overlay.remove()});var fadeStyle=document.createElement('style');fadeStyle.textContent='@keyframes crmFadeIn{from{opacity:0}to{opacity:1}}';document.head.appendChild(fadeStyle);document.body.appendChild(overlay)});ctLabel.appendChild(termosLink)}if(c.texto_ajuda){ctLabel.appendChild(makeHelpIcon(c.texto_ajuda))}ctWrap.appendChild(ctInp);ctWrap.appendChild(ctLabel);group.appendChild(ctWrap);return}")

  // RADIO
  parts.push("else if(c.tipo==='radio'&&c.opcoes){inp=document.createElement('div');inp.setAttribute('data-name',c.nome);var rOpts=Array.isArray(c.opcoes)?c.opcoes:(c.opcoes.opcoes||[]);for(var r=0;r<rOpts.length;r++){var rLabel=document.createElement('label');rLabel.style.cssText='display:flex;align-items:center;gap:8px;font-size:14px;color:#374151;cursor:pointer;margin-bottom:4px';var rInp=document.createElement('input');rInp.type='radio';rInp.name=c.nome;rInp.style.cssText='accent-color:#3B82F6';var rVal=typeof rOpts[r]==='string'?rOpts[r]:(rOpts[r].valor||rOpts[r].label||rOpts[r]);rInp.value=rVal;rLabel.appendChild(rInp);rLabel.appendChild(document.createTextNode(typeof rOpts[r]==='string'?rOpts[r]:(rOpts[r].label||rOpts[r].valor||rOpts[r])));inp.appendChild(rLabel)}}")

  // ENDERECO
  parts.push("else if(c.tipo==='endereco'){inp=document.createElement('div');inp.setAttribute('data-name',c.nome);inp.setAttribute('data-endereco','1');var eRow=document.createElement('div');eRow.style.cssText='display:flex;gap:8px;margin-bottom:8px';var eRua=document.createElement('input');eRua.className='form-input-field';eRua.name=c.nome+'_rua';eRua.placeholder='Rua / Logradouro';eRua.style.cssText=inputCss+';flex:1';var eNum=document.createElement('input');eNum.className='form-input-field';eNum.name=c.nome+'_numero';eNum.placeholder='N\\u00ba';eNum.style.cssText=inputCss+';flex:0;width:80px;min-width:70px';eRow.appendChild(eRua);eRow.appendChild(eNum);var eComp=document.createElement('input');eComp.className='form-input-field';eComp.name=c.nome+'_complemento';eComp.placeholder='Complemento (opcional)';eComp.style.cssText=inputCss;inp.appendChild(eRow);inp.appendChild(eComp)}")

  // ESTADO (select com UFs)
  parts.push("else if(c.tipo==='estado'){inp=document.createElement('select');inp.style.cssText=inputCss+';appearance:auto';var defOpt=document.createElement('option');defOpt.value='';defOpt.textContent='Selecione o estado...';inp.appendChild(defOpt);for(var u=0;u<ESTADOS_BR.length;u++){var ufOpt=document.createElement('option');ufOpt.value=ESTADOS_BR[u];ufOpt.textContent=ESTADOS_BR[u];inp.appendChild(ufOpt)}}")

  // PAIS (select com paÃ­ses)
  parts.push("else if(c.tipo==='pais'){inp=document.createElement('select');inp.style.cssText=inputCss+';appearance:auto';var defOpt=document.createElement('option');defOpt.value='';defOpt.textContent='Selecione o pa\\u00eds...';inp.appendChild(defOpt);for(var p=0;p<PAISES_DDI.length;p++){var pOpt=document.createElement('option');pOpt.value=PAISES_DDI[p].f+' '+PAISES_DDI[p].c;pOpt.textContent=PAISES_DDI[p].f+' '+PAISES_DDI[p].c;inp.appendChild(pOpt)}}")

  // AVALIACAO (estrelas)
  parts.push("else if(c.tipo==='avaliacao'){inp=document.createElement('div');inp.setAttribute('data-name',c.nome);inp.style.cssText='display:flex;gap:4px;margin-top:4px';for(var s=1;s<=5;s++){var star=document.createElement('button');star.type='button';star.textContent='\\u2605';star.setAttribute('data-star',s);star.style.cssText='background:none;border:none;cursor:pointer;font-size:28px;color:#D1D5DB;padding:2px;line-height:1;transition:color 0.15s';(function(sv,container){star.addEventListener('click',function(){container.setAttribute('data-value',sv);var stars=container.querySelectorAll('button');for(var si=0;si<stars.length;si++){stars[si].style.color=parseInt(stars[si].getAttribute('data-star'))<=sv?'#FBBF24':'#D1D5DB'}})})(s,inp);inp.appendChild(star)}}")

  // NPS (0-10)
  parts.push("else if(c.tipo==='nps'){inp=document.createElement('div');inp.setAttribute('data-name',c.nome);inp.style.cssText='margin-top:6px';var npsRow=document.createElement('div');npsRow.style.cssText='display:flex;gap:4px;flex-wrap:wrap';for(var n=0;n<=10;n++){var nb=document.createElement('button');nb.type='button';nb.textContent=n;nb.setAttribute('data-nps',n);nb.style.cssText='width:36px;height:36px;border-radius:8px;border:1px solid #D1D5DB;background:#FFFFFF;color:#6B7280;font-weight:500;font-size:14px;cursor:pointer;transition:all 0.15s';(function(nv,container){nb.addEventListener('click',function(){container.setAttribute('data-value',nv);var btns=container.querySelectorAll('button[data-nps]');for(var ni=0;ni<btns.length;ni++){var bv=parseInt(btns[ni].getAttribute('data-nps'));if(bv===nv){btns[ni].style.border='2px solid #3B82F6';btns[ni].style.fontWeight='700';btns[ni].style.color='#1F2937';btns[ni].style.backgroundColor=bv<=6?'#FEE2E2':bv<=8?'#FEF3C7':'#DCFCE7'}else{btns[ni].style.border='1px solid #D1D5DB';btns[ni].style.fontWeight='500';btns[ni].style.color='#6B7280';btns[ni].style.backgroundColor='#FFFFFF'}}})})(n,inp);npsRow.appendChild(nb)}inp.appendChild(npsRow);var npsLabels=document.createElement('div');npsLabels.style.cssText='display:flex;justify-content:space-between;margin-top:4px;font-size:11px;color:#9CA3AF';var nl1=document.createElement('span');nl1.textContent='Nada prov\\u00e1vel';var nl2=document.createElement('span');nl2.textContent='Muito prov\\u00e1vel';npsLabels.appendChild(nl1);npsLabels.appendChild(nl2);inp.appendChild(npsLabels)}")

  // SLIDER (range)
  parts.push("else if(c.tipo==='slider'){inp=document.createElement('div');inp.setAttribute('data-name',c.nome);inp.style.cssText='margin-top:4px';var slVal=document.createElement('div');slVal.style.cssText='display:flex;justify-content:space-between;font-size:12px;color:#6B7280;margin-bottom:4px';var slMin=document.createElement('span');slMin.textContent='0';var slMax=document.createElement('span');slMax.textContent='100';slVal.appendChild(slMin);slVal.appendChild(slMax);var slInp=document.createElement('input');slInp.type='range';slInp.min='0';slInp.max='100';slInp.value='50';slInp.name=c.nome;slInp.style.cssText='width:100%;accent-color:#3B82F6;cursor:pointer';inp.appendChild(slVal);inp.appendChild(slInp)}")

  // ASSINATURA (canvas para desenhar)
  parts.push("else if(c.tipo==='assinatura'){inp=document.createElement('div');inp.setAttribute('data-name',c.nome);inp.style.cssText='position:relative';var sigCanvas=document.createElement('canvas');sigCanvas.width=400;sigCanvas.height=120;sigCanvas.style.cssText='width:100%;height:120px;border:1px dashed '+(fS.input_border_color||borderColor||'#D1D5DB')+';border-radius:'+(fS.input_border_radius||'6px')+';background:'+(fS.input_background||'#F9FAFB')+';cursor:crosshair;touch-action:none';var sigHidden=document.createElement('input');sigHidden.type='hidden';sigHidden.name=c.nome;var sigCtx=sigCanvas.getContext('2d');var drawing=false;function getPos(e,cv){var r=cv.getBoundingClientRect();var t=e.touches?e.touches[0]:e;return{x:(t.clientX-r.left)*(cv.width/r.width),y:(t.clientY-r.top)*(cv.height/r.height)}}sigCanvas.addEventListener('mousedown',function(e){drawing=true;sigCtx.beginPath();var p=getPos(e,sigCanvas);sigCtx.moveTo(p.x,p.y)});sigCanvas.addEventListener('mousemove',function(e){if(!drawing)return;var p=getPos(e,sigCanvas);sigCtx.lineWidth=2;sigCtx.lineCap='round';sigCtx.strokeStyle='#1F2937';sigCtx.lineTo(p.x,p.y);sigCtx.stroke()});sigCanvas.addEventListener('mouseup',function(){drawing=false;sigHidden.value=sigCanvas.toDataURL()});sigCanvas.addEventListener('touchstart',function(e){e.preventDefault();drawing=true;sigCtx.beginPath();var p=getPos(e,sigCanvas);sigCtx.moveTo(p.x,p.y)},{passive:false});sigCanvas.addEventListener('touchmove',function(e){e.preventDefault();if(!drawing)return;var p=getPos(e,sigCanvas);sigCtx.lineWidth=2;sigCtx.lineCap='round';sigCtx.strokeStyle='#1F2937';sigCtx.lineTo(p.x,p.y);sigCtx.stroke()},{passive:false});sigCanvas.addEventListener('touchend',function(){drawing=false;sigHidden.value=sigCanvas.toDataURL()});var sigClear=document.createElement('button');sigClear.type='button';sigClear.textContent='Limpar';sigClear.style.cssText='position:absolute;top:4px;right:4px;background:#fff;border:1px solid #D1D5DB;border-radius:4px;padding:2px 8px;font-size:11px;color:#6B7280;cursor:pointer';sigClear.addEventListener('click',function(){sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);sigHidden.value=''});inp.appendChild(sigCanvas);inp.appendChild(sigClear);inp.appendChild(sigHidden)}")

  // COR (color picker)
  parts.push("else if(c.tipo==='cor'){inp=document.createElement('div');inp.setAttribute('data-name',c.nome);inp.style.cssText='display:flex;align-items:center;gap:8px;margin-top:4px';var colorInp=document.createElement('input');colorInp.type='color';colorInp.name=c.nome;colorInp.value='#3B82F6';colorInp.style.cssText='width:48px;height:32px;border:none;cursor:pointer;padding:0';var colorVal=document.createElement('span');colorVal.style.cssText='font-size:14px;color:#374151';colorVal.textContent='#3B82F6';colorInp.addEventListener('input',function(){colorVal.textContent=this.value});inp.appendChild(colorInp);inp.appendChild(colorVal)}")

  // RANKING (ordered list)
  parts.push("else if(c.tipo==='ranking'){inp=document.createElement('div');inp.setAttribute('data-name',c.nome);var rOpts2=Array.isArray(c.opcoes)?c.opcoes:(c.opcoes&&c.opcoes.opcoes?c.opcoes.opcoes:['Item 1','Item 2','Item 3']);for(var ri=0;ri<rOpts2.length;ri++){var rItem=document.createElement('div');rItem.style.cssText=inputCss.replace(/height:[^;]+;/,'')+';padding:6px 12px;margin-bottom:4px;display:flex;align-items:center;gap:8px';var rIdx=document.createElement('span');rIdx.textContent=(ri+1)+'.';rIdx.style.cssText='font-weight:600;color:#6B7280';rItem.appendChild(rIdx);rItem.appendChild(document.createTextNode(typeof rOpts2[ri]==='string'?rOpts2[ri]:(rOpts2[ri].label||rOpts2[ri].valor||'Item '+(ri+1))));inp.appendChild(rItem)}}")

  // ARQUIVO / UPLOAD types â€” with hidden file input + click handler
  parts.push("else if(c.tipo==='arquivo'||c.tipo==='imagem'||c.tipo==='documento'||c.tipo==='upload_video'||c.tipo==='upload_audio'||c.tipo==='anexo_arquivo'||c.tipo==='upload_imagem'){inp=document.createElement('div');inp.setAttribute('data-name',c.nome);var acceptMap={imagem:'image/*',upload_imagem:'image/*',upload_video:'video/*',upload_audio:'audio/*',documento:'.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx',arquivo:'*/*',anexo_arquivo:'*/*'};var upFileInp=document.createElement('input');upFileInp.type='file';upFileInp.name=c.nome;upFileInp.accept=acceptMap[c.tipo]||'*/*';upFileInp.style.cssText='display:none';var upArea=document.createElement('div');upArea.style.cssText=inputCss.replace(/height:[^;]+;/,'')+';padding:16px;text-align:center;color:#9CA3AF;border-style:dashed;cursor:pointer;font-family:'+fontFamily+';font-size:14px;transition:border-color 0.2s';upArea.textContent='\\uD83D\\uDCCE Clique ou arraste para enviar';upArea.addEventListener('click',function(){upFileInp.click()});upArea.addEventListener('dragover',function(e){e.preventDefault();this.style.borderColor='#3B82F6'});upArea.addEventListener('dragleave',function(){this.style.borderColor=borderColor});upArea.addEventListener('drop',function(e){e.preventDefault();this.style.borderColor=borderColor;if(e.dataTransfer&&e.dataTransfer.files.length>0){upFileInp.files=e.dataTransfer.files;this.textContent='\\u2705 '+e.dataTransfer.files[0].name}});upFileInp.addEventListener('change',function(){if(this.files&&this.files.length>0){upArea.textContent='\\u2705 '+this.files[0].name}});inp.appendChild(upArea);inp.appendChild(upFileInp)}")

  // DEFAULT (input)
  parts.push("else{inp=document.createElement('input');inp.type=inputType(c.tipo);inp.style.cssText=inputCss}")

  // Common setup for non-DIV elements
  parts.push("if(inp&&inp.tagName!=='DIV'){inp.className='form-input-field';inp.name=c.nome;if(c.placeholder)inp.placeholder=c.placeholder;if(c.obrigatorio)inp.required=true;inp.addEventListener('focus',function(){this.style.borderColor='#3B82F6'});inp.addEventListener('blur',function(){this.style.borderColor=borderColor});var mk=maskFor(c.tipo);if(mk)mk(inp)}")
  parts.push("if(inp)group.appendChild(inp)}")

  // buildForm function
  parts.push("function buildForm(data,container){")
  parts.push("var form=data.formulario;var campos=data.campos;var estilos=data.estilos||{};")
  parts.push("var cS=estilos.container||{};var fS=estilos.campos||{};var bS=estilos.botao||{};var hS=estilos.cabecalho||{};")
  parts.push("var btnConfig=form.config_botoes||{};var tipoBotao=btnConfig.tipo_botao||'enviar';")
  parts.push("var fontFamily=cS.font_family?(cS.font_family+\",'Inter',system-ui,sans-serif\"):\"'Inter',system-ui,sans-serif\";")
  parts.push("var padTop=cS.padding_top||'24';var padRight=cS.padding_right||'24';var padBottom=cS.padding_bottom||'24';var padLeft=cS.padding_left||'24';")
  parts.push("var padding=padTop+'px '+padRight+'px '+padBottom+'px '+padLeft+'px';")
  parts.push("var borderCss='';if(cS.border_width&&parseInt(cS.border_width)>0)borderCss='border:'+cS.border_width+'px solid '+(cS.border_color||'#D1D5DB')+';';")
  parts.push("var sombras={none:'none',sm:'0 1px 2px 0 rgb(0 0 0/0.05)',md:'0 4px 6px -1px rgb(0 0 0/0.1)',lg:'0 10px 15px -3px rgb(0 0 0/0.1)',xl:'0 20px 25px -5px rgb(0 0 0/0.1)'};")
  parts.push("var sombra=sombras[cS.sombra||'md']||sombras.md;")
  parts.push("var wrapper=document.createElement('div');wrapper.setAttribute('data-form-id',form.id);")
  parts.push("wrapper.style.cssText='font-family:'+fontFamily+';max-width:'+(cS.max_width||'600px')+';margin:0 auto;padding:'+padding+';background:'+(cS.background_color||'#ffffff')+';border-radius:'+(cS.border_radius||'8px')+';'+borderCss+'box-shadow:'+sombra+';box-sizing:border-box';")

  // Responsive CSS
  parts.push("var styleEl=document.createElement('style');var rcss='';var prefix='[data-form-id=\"'+form.id+'\"]';")
  parts.push("function addResponsive(sel,prop,field,obj,transform){var tv=obj[field+'_tablet'];var mv=obj[field+'_mobile'];if(tv){var v=transform?transform(tv):tv;rcss+='@media(min-width:768px)and(max-width:1023px){'+sel+'{'+prop+':'+v+' !important}}'}if(mv){var v2=transform?transform(mv):mv;rcss+='@media(max-width:767px){'+sel+'{'+prop+':'+v2+' !important}}'}}")
  parts.push("var larguraToCSS=function(v){return v==='full'?'100%':v==='auto'?'auto':v};")
  parts.push("addResponsive(prefix+' .form-btn-submit','width','largura',bS,larguraToCSS);addResponsive(prefix+' .form-btn-submit','height','altura',bS);addResponsive(prefix+' .form-btn-submit','font-size','font_size',bS);")
  parts.push("addResponsive(prefix+' .form-btn-whatsapp','width','whatsapp_largura',bS,larguraToCSS);addResponsive(prefix+' .form-btn-whatsapp','height','whatsapp_altura',bS);addResponsive(prefix+' .form-btn-whatsapp','font-size','whatsapp_font_size',bS);")
  parts.push("addResponsive(prefix,'padding-top','padding_top',cS,function(v){return v+'px'});addResponsive(prefix,'padding-right','padding_right',cS,function(v){return v+'px'});addResponsive(prefix,'padding-bottom','padding_bottom',cS,function(v){return v+'px'});addResponsive(prefix,'padding-left','padding_left',cS,function(v){return v+'px'});addResponsive(prefix,'max-width','max_width',cS);")
  parts.push("addResponsive(prefix+' .form-input-field','height','input_height',fS);addResponsive(prefix+' .form-label','font-size','label_tamanho',fS);")
  parts.push("var mLargura=bS.largura_mobile;var mWLargura=bS.whatsapp_largura_mobile;if(mLargura||mWLargura){var shouldStack=larguraToCSS(mLargura||bS.largura||'full')==='100%'||larguraToCSS(mWLargura||bS.whatsapp_largura||'full')==='100%';if(shouldStack)rcss+='@media(max-width:767px){'+prefix+' .form-btns-wrapper{flex-direction:column !important}'+prefix+' .form-btns-wrapper>div{width:100% !important}}'}")
  parts.push("var tLargura=bS.largura_tablet;var tWLargura=bS.whatsapp_largura_tablet;if(tLargura||tWLargura){var shouldStack2=larguraToCSS(tLargura||bS.largura||'full')==='100%'||larguraToCSS(tWLargura||bS.whatsapp_largura||'full')==='100%';if(shouldStack2)rcss+='@media(min-width:768px)and(max-width:1023px){'+prefix+' .form-btns-wrapper{flex-direction:column !important}'+prefix+' .form-btns-wrapper>div{width:100% !important}}'}")
  parts.push("if(rcss){styleEl.textContent=rcss;wrapper.appendChild(styleEl)}")

  // Header
  parts.push("if(hS.logo_url||form.descricao){var hDiv=document.createElement('div');hDiv.style.cssText='margin-bottom:24px;text-align:center';if(hS.logo_url){var logo=document.createElement('img');logo.src=hS.logo_url;logo.alt='Logo';logo.style.cssText='max-height:40px;margin-bottom:8px;display:inline-block';hDiv.appendChild(logo)}if(form.descricao){var desc=document.createElement('p');desc.textContent=form.descricao;desc.style.cssText='color:'+(hS.descricao_cor||'#6b7280')+';font-size:'+(hS.descricao_tamanho||'14px')+';margin:4px 0 0 0;font-family:'+fontFamily;hDiv.appendChild(desc)}wrapper.appendChild(hDiv)}")

  // Form element and field styles
  parts.push("var formEl=document.createElement('form');formEl.style.cssText='display:flex;flex-wrap:wrap';")
  parts.push("var bw=fS.input_border_width||'1';var bsv=fS.input_border_style||'solid';var bc=fS.input_border_color||'#D1D5DB';")
  parts.push("var inputCss='width:100%;background:'+(fS.input_background||'#F9FAFB')+';border:'+bw+'px '+bsv+' '+bc+';border-radius:'+(fS.input_border_radius||'6px')+';color:'+(fS.input_texto_cor||'#1F2937')+';padding:8px 12px;font-size:14px;height:'+(fS.input_height||'40px')+';outline:none;font-family:'+fontFamily+';box-sizing:border-box';")
  parts.push("var labelCss='color:'+(fS.label_cor||'#374151')+';font-size:'+(fS.label_tamanho||'14px')+';font-weight:'+(fS.label_font_weight||'500')+';display:block;margin-bottom:4px;font-family:'+fontFamily;")
  // AIDEV-NOTE: Usar check explÃ­cito para nÃ£o tratar 0 como falsy
  parts.push("function safeGap(v,fb){return(v!==undefined&&v!==null&&v!=='')?v:fb}")
  parts.push("var gapTop=safeGap(fS.gap_top,safeGap(fS.gap,'12'));var gapRight=safeGap(fS.gap_right,'0');var gapBottom=safeGap(fS.gap_bottom,'0');var gapLeft=safeGap(fS.gap_left,'0');")
  parts.push("var fieldPadding=gapTop+'px '+gapRight+'px '+gapBottom+'px '+gapLeft+'px';")
  // AIDEV-NOTE: getFieldPad â€” usa APENAS validacoes.spacing_* com fallback '0', igual ao editor frontend
  parts.push("function getFieldPad(c){var v=c.validacoes||{};function safe(x){return(x!==undefined&&x!==null&&x!=='')?x:'0'}return safe(v.spacing_top)+'px '+safe(v.spacing_right)+'px '+safe(v.spacing_bottom)+'px '+safe(v.spacing_left)+'px'}")

  // Field rendering loop
  parts.push("for(var i=0;i<campos.length;i++){var c=campos[i];if(c.pai_campo_id)continue;if(c.tipo==='botao_enviar'||c.tipo==='botao_whatsapp')continue;")
  // AIDEV-NOTE: Titulo â€” prioridade de cor: estilo_campo.label_cor > valor_padrao.cor > global. Font-size com ensurePx.
  parts.push("if(c.tipo==='titulo'){var tc=parseLayoutConfig(c.valor_padrao,'titulo');var tEC=(c.validacoes||{}).estilo_campo||{};var tFontSize=ensurePx(tEC.label_tamanho||tc.tamanho,'18px');var tColor=tEC.label_cor||tc.cor||fS.label_cor||'#374151';var tWeight=tEC.label_font_weight||'600';var tEl=document.createElement('h3');tEl.textContent=c.placeholder||c.label;tEl.style.cssText='width:100%;padding:'+getFieldPad(c)+';box-sizing:border-box;font-size:'+tFontSize+';font-weight:'+tWeight+';margin:0;text-align:'+tc.alinhamento+';color:'+tColor+';font-family:'+fontFamily;formEl.appendChild(tEl);continue}")
  // AIDEV-NOTE: Paragrafo â€” mesma logica de prioridade que titulo
  parts.push("if(c.tipo==='paragrafo'){var pc=parseLayoutConfig(c.valor_padrao,'paragrafo');var pEC=(c.validacoes||{}).estilo_campo||{};var pFontSize=ensurePx(pEC.label_tamanho||pc.tamanho,'14px');var pColor=pEC.label_cor||pc.cor||fS.label_cor||'#374151';var pWeight=pEC.label_font_weight||'400';var pEl=document.createElement('p');pEl.textContent=c.placeholder||c.label;pEl.style.cssText='width:100%;padding:'+getFieldPad(c)+';box-sizing:border-box;font-size:'+pFontSize+';font-weight:'+pWeight+';margin:0;text-align:'+pc.alinhamento+';color:'+pColor+';font-family:'+fontFamily;formEl.appendChild(pEl);continue}")
  parts.push("if(c.tipo==='divisor'){var dc=parseLayoutConfig(c.valor_padrao,'divisor');var hr=document.createElement('hr');hr.style.cssText='width:100%;padding:'+getFieldPad(c)+';box-sizing:border-box;border:none;border-top:'+dc.espessura+'px '+dc.estilo+' '+dc.cor;formEl.appendChild(hr);continue}")
  parts.push("if(c.tipo==='espacador'){var ec=parseLayoutConfig(c.valor_padrao,'espacador');var sp=document.createElement('div');sp.style.cssText='width:100%;height:'+ec.altura+'px';formEl.appendChild(sp);continue}")
  parts.push("if(c.tipo==='bloco_html'){var htmlDiv=document.createElement('div');htmlDiv.style.cssText='width:100%;padding:'+getFieldPad(c)+';box-sizing:border-box;font-size:14px;font-family:'+fontFamily;htmlDiv.innerHTML=c.valor_padrao||'';formEl.appendChild(htmlDiv);continue}")
  parts.push("if(c.tipo==='imagem_link'){var imgWrap=document.createElement('div');imgWrap.style.cssText='width:100%;padding:'+getFieldPad(c)+';box-sizing:border-box';try{var imgP=JSON.parse(c.valor_padrao||'{}');var isMob=window.innerWidth<768;var isTab=window.innerWidth>=768&&window.innerWidth<1024;var imgUrl=(isMob&&imgP.url_mobile)||(isTab&&imgP.url_tablet)||imgP.url_desktop||imgP.url_tablet||imgP.url_mobile||'';var linkUrl=imgP.redirect_url||'';if(imgUrl){var imgEl=document.createElement('img');imgEl.src=imgUrl;imgEl.alt=c.label;imgEl.style.cssText='width:100%;border-radius:8px;display:block';if(linkUrl){var a=document.createElement('a');a.href=linkUrl;a.target='_blank';a.rel='noopener noreferrer';a.appendChild(imgEl);imgWrap.appendChild(a)}else imgWrap.appendChild(imgEl)}}catch(e){}formEl.appendChild(imgWrap);continue}")
  parts.push("if(c.tipo==='oculto')continue;if(isLayoutField(c.tipo))continue;")

  // Column blocks
  parts.push("if(c.tipo==='bloco_colunas'){var colWrap=document.createElement('div');colWrap.style.cssText='width:100%;padding:'+getFieldPad(c)+';box-sizing:border-box';try{var cp=JSON.parse(c.valor_padrao||'{}');var ncols=parseInt(cp.colunas)||2;var larguras=(cp.larguras||'50%,50%').split(',');var gap=cp.gap||'16';var colContainer=document.createElement('div');colContainer.setAttribute('data-bloco-id',c.id);colContainer.style.cssText='display:flex;flex-wrap:wrap;gap:'+gap+'px';")
  parts.push("var mobileL=cp.larguras_mobile||Array(ncols).fill('100%').join(',');var mW=mobileL.split(',');var colRcss='@media(max-width:767px){[data-bloco-id=\"'+c.id+'\"]{flex-wrap:wrap !important}';for(var mi=0;mi<mW.length;mi++)colRcss+='[data-bloco-id=\"'+c.id+'\"]>.col-'+mi+'{width:'+mW[mi].trim()+' !important}';colRcss+='}';")
  parts.push("if(cp.larguras_tablet){var tW=cp.larguras_tablet.split(',');colRcss+='@media(min-width:768px)and(max-width:1023px){[data-bloco-id=\"'+c.id+'\"]{flex-wrap:wrap !important}';for(var ti=0;ti<tW.length;ti++)colRcss+='[data-bloco-id=\"'+c.id+'\"]>.col-'+ti+'{width:'+tW[ti].trim()+' !important}';colRcss+='}'}")
  parts.push("var colStyle=document.createElement('style');colStyle.textContent=colRcss;colWrap.appendChild(colStyle);")
  parts.push("for(var ci=0;ci<ncols;ci++){var col=document.createElement('div');col.className='col-'+ci;var rawW=larguras[ci]?larguras[ci].trim():(Math.floor(100/ncols)+'%');var gapPx=parseInt(gap)||16;var totalGap=gapPx*(ncols-1);var w=rawW.endsWith('%')?'calc('+rawW+' - '+(totalGap*parseFloat(rawW)/100)+'px)':rawW;col.style.cssText='width:'+w+';display:flex;flex-wrap:wrap';")
  parts.push("var children=campos.filter(function(ch){return ch.pai_campo_id===c.id&&ch.coluna_indice===ci}).sort(function(a,b){return a.ordem-b.ordem});for(var cj=0;cj<children.length;cj++){var child=children[cj];var cDiv=document.createElement('div');cDiv.setAttribute('data-campo-tipo',child.tipo);cDiv.setAttribute('data-campo-id',child.id||'');var cw=child.largura==='1/2'||child.largura==='half'?'50%':child.largura==='1/3'||child.largura==='third'?'33.33%':child.largura==='2/3'?'66.66%':'100%';cDiv.style.cssText='width:'+cw+';padding:'+getFieldPad(child)+';box-sizing:border-box';")
  // AIDEV-NOTE: Merge individual de estilos para campos dentro de colunas
  parts.push("var chFS=mergeFieldStyle(fS,child);var chBw=chFS.input_border_width||'1';var chBsv=chFS.input_border_style||'solid';var chBc=chFS.input_border_color||'#D1D5DB';var chInputCss='width:100%;background:'+(chFS.input_background||'#F9FAFB')+';border:'+chBw+'px '+chBsv+' '+chBc+';border-radius:'+ensurePx(chFS.input_border_radius,'6px')+';color:'+(chFS.input_texto_cor||'#1F2937')+';padding:8px 12px;font-size:14px;height:'+ensurePx(chFS.input_height,'40px')+';outline:none;font-family:'+fontFamily+';box-sizing:border-box';")
  parts.push("var chLabelCss='color:'+(chFS.label_cor||'#374151')+';font-size:'+ensurePx(chFS.label_tamanho,'14px')+';font-weight:'+(chFS.label_font_weight||'500')+';display:block;margin-bottom:4px;font-family:'+fontFamily;")
  parts.push("renderField(child,cDiv,chLabelCss,chInputCss,fontFamily,chBc,chFS);col.appendChild(cDiv)}")
  parts.push("colContainer.appendChild(col)}colWrap.appendChild(colContainer)}catch(e){}formEl.appendChild(colWrap);continue}")

  // AIDEV-NOTE: Para campos dentro de blocos de colunas, gerar estilos merged por campo
  parts.push("var larguraMap={full:'100%','1/2':'50%','1/3':'33.33%','2/3':'66.66%',half:'50%',third:'33.33%'};var fw=larguraMap[c.largura]||'100%';var group=document.createElement('div');group.setAttribute('data-campo-tipo',c.tipo);group.setAttribute('data-campo-id',c.id||'');group.style.cssText='width:'+fw+';padding:'+getFieldPad(c)+';box-sizing:border-box';")
  // AIDEV-NOTE: Merge individual de estilos por campo â€” cada campo pode ter overrides em validacoes.estilo_campo
  parts.push("var mFS=mergeFieldStyle(fS,c);var mBw=mFS.input_border_width||'1';var mBsv=mFS.input_border_style||'solid';var mBc=mFS.input_border_color||'#D1D5DB';var mInputCss='width:100%;background:'+(mFS.input_background||'#F9FAFB')+';border:'+mBw+'px '+mBsv+' '+mBc+';border-radius:'+ensurePx(mFS.input_border_radius,'6px')+';color:'+(mFS.input_texto_cor||'#1F2937')+';padding:8px 12px;font-size:14px;height:'+ensurePx(mFS.input_height,'40px')+';outline:none;font-family:'+fontFamily+';box-sizing:border-box';")
  parts.push("var mLabelCss='color:'+(mFS.label_cor||'#374151')+';font-size:'+ensurePx(mFS.label_tamanho,'14px')+';font-weight:'+(mFS.label_font_weight||'500')+';display:block;margin-bottom:4px;font-family:'+fontFamily;")
  parts.push("renderField(c,group,mLabelCss,mInputCss,fontFamily,mBc,mFS);formEl.appendChild(group)}")

  // LGPD
  parts.push("if(form.lgpd_ativo){var lgpdGroup=document.createElement('div');lgpdGroup.style.cssText='width:100%;display:flex;align-items:flex-start;gap:8px;margin-top:12px;font-size:13px;font-family:'+fontFamily;var lgpdCb=document.createElement('input');lgpdCb.type='checkbox';lgpdCb.name='_lgpd_consent';if(form.lgpd_checkbox_obrigatorio)lgpdCb.required=true;lgpdCb.style.cssText='margin-top:2px;width:16px;height:16px;accent-color:#3B82F6;flex-shrink:0';var lgpdLabel=document.createElement('span');lgpdLabel.style.cssText='color:#4B5563;line-height:1.4';var lgpdText=form.lgpd_texto_consentimento||'Ao enviar este formul\\u00e1rio, voc\\u00ea concorda com nossa Pol\\u00edtica de Privacidade.';if(form.lgpd_url_politica){lgpdLabel.innerHTML=lgpdText+' <a href=\"'+form.lgpd_url_politica+'\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"color:#3B82F6;text-decoration:underline\">Pol\\u00edtica de Privacidade</a>';if(form.lgpd_checkbox_obrigatorio)lgpdLabel.innerHTML+='<span style=\"color:#EF4444;margin-left:2px\">*</span>'}else lgpdLabel.textContent=lgpdText;lgpdGroup.appendChild(lgpdCb);lgpdGroup.appendChild(lgpdLabel);formEl.appendChild(lgpdGroup)}")

  // Buttons
  parts.push("var showEnviar=tipoBotao==='enviar'||tipoBotao==='ambos';var showWhatsApp=tipoBotao==='whatsapp'||tipoBotao==='ambos';var btnText=bS.texto||'Enviar';var btnsDiv=document.createElement('div');btnsDiv.style.cssText='width:100%;margin-top:16px';")
  parts.push("var enviarBtn=null;if(showEnviar){enviarBtn=document.createElement('button');enviarBtn.type='submit';enviarBtn.className='form-btn-submit';enviarBtn.textContent=btnText;var envW=tipoBotao==='ambos'?'100%':resolveLargura(bS.largura);enviarBtn.style.cssText='background:'+(bS.background_color||'#3B82F6')+';color:'+(bS.texto_cor||'#FFFFFF')+';border-radius:'+(bS.border_radius||'6px')+';width:'+envW+';'+(bS.altura?'height:'+bS.altura+';':'')+'padding:'+(bS.altura?'0 20px':'10px 20px')+';font-size:'+(bS.font_size||'14px')+';font-weight:'+(bS.font_bold?'700':'600')+';'+(bS.font_italic?'font-style:italic;':'')+(bS.font_underline?'text-decoration:underline;':'')+'border:none;cursor:pointer;font-family:'+fontFamily+';transition:opacity 0.2s,background-color 0.2s;display:inline-flex;align-items:center;justify-content:center;box-sizing:border-box';enviarBtn.addEventListener('mouseenter',function(){this.style.backgroundColor=bS.hover_background||'#2563EB'});enviarBtn.addEventListener('mouseleave',function(){this.style.backgroundColor=bS.background_color||'#3B82F6'})}")

  // WhatsApp SVG as variable
  const waSvg = '<svg width=\\"16\\" height=\\"16\\" viewBox=\\"0 0 24 24\\" fill=\\"currentColor\\"><path d=\\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z\\"/></svg>'

  parts.push("var whatsAppBtn=null;if(showWhatsApp){whatsAppBtn=document.createElement('button');whatsAppBtn.type='button';whatsAppBtn.className='form-btn-whatsapp';var waW=tipoBotao==='ambos'?'100%':resolveLargura(bS.whatsapp_largura);whatsAppBtn.style.cssText='background:'+(bS.whatsapp_background||'#25D366')+';color:'+(bS.whatsapp_texto_cor||'#FFFFFF')+';border-radius:'+(bS.whatsapp_border_radius||bS.border_radius||'6px')+';width:'+waW+';'+(bS.whatsapp_altura?'height:'+bS.whatsapp_altura+';':'')+'padding:'+(bS.whatsapp_altura?'0 20px':'10px 20px')+';font-size:'+(bS.whatsapp_font_size||'14px')+';font-weight:'+(bS.whatsapp_font_bold?'700':'600')+';'+(bS.whatsapp_font_italic?'font-style:italic;':'')+(bS.whatsapp_font_underline?'text-decoration:underline;':'')+'border:none;cursor:pointer;font-family:'+fontFamily+';transition:opacity 0.2s;display:inline-flex;align-items:center;justify-content:center;gap:8px;box-sizing:border-box';whatsAppBtn.innerHTML='" + waSvg + "'+(bS.whatsapp_texto||'Enviar via WhatsApp');")
  parts.push("whatsAppBtn.addEventListener('click',function(){var numero=btnConfig.whatsapp_numero||'';var msg=btnConfig.whatsapp_mensagem_template||'';if(!msg){var lines=[];var inputs=formEl.querySelectorAll('input,textarea,select');for(var k=0;k<inputs.length;k++){if(inputs[k].name&&inputs[k].name[0]!=='_'&&inputs[k].value)lines.push('*'+inputs[k].name+':* '+inputs[k].value)}msg=lines.join('\\\\n')}window.open('https://wa.me/'+numero+'?text='+encodeURIComponent(msg),'_blank')})}")

  // Button layout
  parts.push("if(tipoBotao==='ambos'){var larguraEnviar=bS.largura||'full';var larguraWhatsApp=bS.whatsapp_largura||'full';var ladoALado=larguraEnviar==='50%'&&larguraWhatsApp==='50%';var btnWrapper=document.createElement('div');btnWrapper.className='form-btns-wrapper';btnWrapper.style.cssText='display:flex;gap:8px;flex-direction:'+(ladoALado?'row':'column');var d1=document.createElement('div');d1.style.width=ladoALado?'50%':'100%';if(enviarBtn)d1.appendChild(enviarBtn);var d2=document.createElement('div');d2.style.width=ladoALado?'50%':'100%';if(whatsAppBtn)d2.appendChild(whatsAppBtn);btnWrapper.appendChild(d1);btnWrapper.appendChild(d2);btnsDiv.appendChild(btnWrapper)}else if(enviarBtn)btnsDiv.appendChild(enviarBtn);else if(whatsAppBtn)btnsDiv.appendChild(whatsAppBtn);formEl.appendChild(btnsDiv);")

  // Submit handler
  parts.push("formEl.addEventListener('submit',function(e){e.preventDefault();if(enviarBtn){enviarBtn.disabled=true;enviarBtn.textContent='Enviando...';enviarBtn.style.opacity='0.7'}var formData={};var inputs=formEl.querySelectorAll('input,textarea,select');for(var k=0;k<inputs.length;k++){var inp=inputs[k];if(inp.name&&inp.name[0]!=='_'){if(inp.type==='checkbox'&&!inp.closest('[data-multi]'))formData[inp.name]=inp.checked;else if(inp.type==='radio'){if(inp.checked)formData[inp.name]=inp.value}else formData[inp.name]=inp.value}}var radioDivs=formEl.querySelectorAll('div[data-name]:not([data-multi]):not([data-endereco])');for(var r=0;r<radioDivs.length;r++){var dv=radioDivs[r];var dName=dv.getAttribute('data-name');if(dv.getAttribute('data-value')!=null){formData[dName]=dv.getAttribute('data-value')}else{var checked=dv.querySelector('input[type=radio]:checked');if(checked)formData[dName]=checked.value}}var multiDivs=formEl.querySelectorAll('div[data-multi]');for(var m=0;m<multiDivs.length;m++){var name=multiDivs[m].getAttribute('data-name');var checkedBoxes=multiDivs[m].querySelectorAll('input[type=checkbox]:checked');var vals=[];for(var mc=0;mc<checkedBoxes.length;mc++)vals.push(checkedBoxes[mc].value);formData[name]=vals.join('|')}var endDivs=formEl.querySelectorAll('div[data-endereco]');for(var ed=0;ed<endDivs.length;ed++){var eName=endDivs[ed].getAttribute('data-name');var parts2=[];var eInputs=endDivs[ed].querySelectorAll('input');for(var ei=0;ei<eInputs.length;ei++){if(eInputs[ei].value)parts2.push(eInputs[ei].value)}formData[eName]=parts2.join(', ')}")
  parts.push("var payload={formulario_id:form.id,dados:formData,utm_source:getUtms().utm_source||null,utm_medium:getUtms().utm_medium||null,utm_campaign:getUtms().utm_campaign||null,user_agent:navigator.userAgent};")
  parts.push("fetch(SUBMIT,{method:'POST',headers:{'Content-Type':'application/json','apikey':ANON},body:JSON.stringify(payload)})")
  parts.push(".then(function(r){return r.json()})")
  parts.push(".then(function(res){if(res.error){if(enviarBtn){enviarBtn.disabled=false;enviarBtn.textContent=btnText;enviarBtn.style.opacity='1'}alert('Erro: '+res.error);return}var posEnvio=form.config_pos_envio||{};var tipo=posEnvio.tipo_acao_sucesso||posEnvio.tipo||'mensagem';if((tipo==='redirecionar'||tipo==='ambos')&&posEnvio.url_redirecionamento){var tempo=(posEnvio.tempo_redirecionamento||3)*1000;setTimeout(function(){window.location.href=posEnvio.url_redirecionamento},tempo);if(tipo==='ambos'){var msg=posEnvio.mensagem_sucesso||form.mensagem_sucesso||'Formul\\u00e1rio enviado com sucesso!';formEl.innerHTML='<div style=\"text-align:center;padding:24px 0\"><div style=\"font-size:32px;margin-bottom:8px\">\\u2713</div><p style=\"font-size:16px;color:#10B981;font-weight:600;margin:0\">'+msg+'</p></div>'}}else{var msg2=posEnvio.mensagem_sucesso||form.mensagem_sucesso||'Formul\\u00e1rio enviado com sucesso!';formEl.innerHTML='<div style=\"text-align:center;padding:24px 0\"><div style=\"font-size:32px;margin-bottom:8px\">\\u2713</div><p style=\"font-size:16px;color:#10B981;font-weight:600;margin:0\">'+msg2+'</p></div>'}})")
  parts.push(".catch(function(){if(enviarBtn){enviarBtn.disabled=false;enviarBtn.textContent=btnText;enviarBtn.style.opacity='1'}alert('Erro ao enviar formul\\u00e1rio')})});")

  parts.push("wrapper.appendChild(formEl);container.appendChild(wrapper)}")

  // Fetch and render
  parts.push("fetch(API).then(function(r){return r.json()}).then(function(data){if(data.error){console.warn('CRM Renove Form:',data.error);return}")
  parts.push("if(MODE==='inline'){var div=document.createElement('div');div.id='crm-form-'+SLUG;parent.insertBefore(div,el?el.nextSibling:null);buildForm(data,div)}")
  parts.push("if(MODE==='modal'){var triggerBtn=document.createElement('button');var btnCfg=data.formulario.config_botoes||{};triggerBtn.textContent=btnCfg.texto_enviar||'Abrir Formul\\u00e1rio';triggerBtn.style.cssText='padding:12px 24px;background:#3B82F6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600';parent.insertBefore(triggerBtn,el?el.nextSibling:null);triggerBtn.addEventListener('click',function(){var overlay=document.createElement('div');overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;animation:crmFadeIn 0.3s ease';var modal=document.createElement('div');modal.style.cssText='max-height:90vh;overflow-y:auto;width:100%;max-width:600px;position:relative';var closeBtn=document.createElement('button');closeBtn.textContent='\\u2715';closeBtn.style.cssText='position:absolute;top:8px;right:8px;background:none;border:none;font-size:18px;cursor:pointer;color:#6b7280;z-index:1';closeBtn.addEventListener('click',function(){overlay.remove()});overlay.addEventListener('click',function(e){if(e.target===overlay)overlay.remove()});modal.appendChild(closeBtn);buildForm(data,modal);overlay.appendChild(modal);var style=document.createElement('style');style.textContent='@keyframes crmFadeIn{from{opacity:0}to{opacity:1}}';document.head.appendChild(style);document.body.appendChild(overlay)})}")
  parts.push("if(MODE==='sidebar'){var toggle=document.createElement('button');toggle.textContent='\\uD83D\\uDCCB';toggle.style.cssText='position:fixed;right:0;top:50%;transform:translateY(-50%);z-index:99998;padding:12px;background:#3B82F6;color:#fff;border:none;border-radius:8px 0 0 8px;cursor:pointer;font-size:18px;box-shadow:-2px 0 10px rgba(0,0,0,0.1)';var panel=document.createElement('div');panel.style.cssText='position:fixed;right:-420px;top:0;width:400px;max-width:90vw;height:100%;z-index:99999;transition:right 0.3s ease;box-shadow:-4px 0 20px rgba(0,0,0,0.15);background:#fff;overflow-y:auto;padding:16px';var closePanel=document.createElement('button');closePanel.textContent='\\u2715';closePanel.style.cssText='position:absolute;top:12px;right:12px;background:none;border:none;font-size:18px;cursor:pointer;color:#6b7280;z-index:1';var open=false;function togglePanel(){open=!open;panel.style.right=open?'0':'-420px'}toggle.addEventListener('click',togglePanel);closePanel.addEventListener('click',function(){open=false;panel.style.right='-420px'});panel.appendChild(closePanel);buildForm(data,panel);document.body.appendChild(toggle);document.body.appendChild(panel)}")
  parts.push("}).catch(function(err){console.warn('CRM Renove Form: erro ao carregar',err)});")
  parts.push("})()")

  return parts.join("\n")
}
