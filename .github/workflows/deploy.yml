name: Deploy CRM to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite disparo manual

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # 1. Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # 3. Cache node_modules frontend
      - name: Cache frontend node_modules
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: node_modules
          key: frontend-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      # 4. Instalar depend√™ncias frontend (s√≥ quando package-lock mudou)
      - name: Install frontend dependencies
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        run: npm ci

      # 5. Build frontend
      - name: Build frontend
        run: npm run build

      # 6. Cache node_modules backend
      - name: Cache backend node_modules
        id: cache-backend
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: backend-${{ runner.os }}-${{ hashFiles('backend/package-lock.json') }}

      # 7. Build backend
      - name: Build backend
        run: |
          cd backend
          if [ "${{ steps.cache-backend.outputs.cache-hit }}" != "true" ]; then
            npm ci
          fi
          npm run build

      # 6. Configurar SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      # 7. Adicionar host conhecido
      # AIDEV-NOTE: DEPLOY_PORT pode ser 22 (padr√£o) ou porta customizada do servidor
      - name: Add known host
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          PORT="${{ secrets.DEPLOY_PORT }}"
          PORT="${PORT:-22}"
          echo "Verificando host ${{ secrets.DEPLOY_HOST }}:${PORT}..."
          ssh-keyscan -p "${PORT}" -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts
          echo "Host adicionado com sucesso."

      # 8. Criar backup no servidor
      - name: Create backup on server
        run: |
          PORT="${{ secrets.DEPLOY_PORT }}"
          PORT="${PORT:-22}"
          ssh -p "${PORT}" ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'ENDSSH'
            # Backup frontend
            cd /var/www/crm.renovedigital.com.br/frontend
            [ -d dist.backup ] && rm -rf dist.backup || true
            [ -d dist ] && cp -r dist dist.backup || true

            # Backup backend src
            cd /var/www/crm.renovedigital.com.br/backend
            [ -d src.backup ] && rm -rf src.backup || true
            [ -d src ] && cp -r src src.backup || true
          ENDSSH

      # 9. Deploy frontend
      - name: Deploy frontend
        run: |
          PORT="${{ secrets.DEPLOY_PORT }}"
          PORT="${PORT:-22}"
          rsync -avz --delete \
            -e "ssh -p ${PORT}" \
            dist/ \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/var/www/crm.renovedigital.com.br/frontend/dist/

      # 10. Deploy backend
      - name: Deploy backend
        run: |
          PORT="${{ secrets.DEPLOY_PORT }}"
          PORT="${PORT:-22}"

          # Copiar src (usando tsx em produ√ß√£o)
          rsync -avz --delete \
            --exclude='.env' \
            --exclude='node_modules' \
            --exclude='dist' \
            -e "ssh -p ${PORT}" \
            backend/src/ \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/var/www/crm.renovedigital.com.br/backend/src/

          # Copiar package.json, tsconfig e ecosystem
          rsync -avz \
            -e "ssh -p ${PORT}" \
            backend/package.json \
            backend/package-lock.json \
            backend/tsconfig.json \
            backend/ecosystem.config.cjs \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/var/www/crm.renovedigital.com.br/backend/

      # 11. Instalar depend√™ncias e reiniciar servi√ßos
      - name: Install deps and restart services
        run: |
          PORT="${{ secrets.DEPLOY_PORT }}"
          PORT="${PORT:-22}"
          ssh -p "${PORT}" ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'ENDSSH'
            cd /var/www/crm.renovedigital.com.br/backend

            # Instalar depend√™ncias (inclui tsx como dep de produ√ß√£o)
            npm ci

            # Parar processo antigo se existir
            pm2 delete crm-backend 2>/dev/null || true

            # Iniciar com novo ecosystem usando tsx
            pm2 start ecosystem.config.cjs
            pm2 save

            # Reload Nginx
            nginx -t && systemctl reload nginx

            # Aguardar startup
            sleep 5
          ENDSSH

      # 12. Health check
      - name: Health check
        run: |
          # Verificar frontend
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://crm.renovedigital.com.br/ || echo "000")
          echo "Frontend status: $FRONTEND_STATUS"

          # Verificar backend
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.DEPLOY_HOST }}:3001/health || echo "000")
          echo "Backend status: $BACKEND_STATUS"

          if [ "$FRONTEND_STATUS" != "200" ] && [ "$FRONTEND_STATUS" != "304" ]; then
            echo "‚ö†Ô∏è Frontend check: $FRONTEND_STATUS (pode ser normal se n√£o h√° index.html ainda)"
          fi

          echo "‚úÖ Deploy completed!"

      # 13. Rollback em caso de falha
      - name: Rollback on failure
        if: failure()
        continue-on-error: true
        run: |
          PORT="${{ secrets.DEPLOY_PORT }}"
          PORT="${PORT:-22}"
          ssh -p "${PORT}" ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'ENDSSH'
            echo "üîÑ Iniciando rollback..."

            # Restaurar frontend
            cd /var/www/crm.renovedigital.com.br/frontend
            if [ -d dist.backup ]; then
              rm -rf dist
              mv dist.backup dist
              echo "‚úÖ Frontend restaurado"
            fi

            # Restaurar backend src
            cd /var/www/crm.renovedigital.com.br/backend
            if [ -d src.backup ]; then
              rm -rf src
              mv src.backup src
              echo "‚úÖ Backend restaurado"
            fi

            # Reiniciar servi√ßos
            pm2 restart crm-backend || true
            systemctl reload nginx

            echo "‚úÖ Rollback conclu√≠do"
          ENDSSH
